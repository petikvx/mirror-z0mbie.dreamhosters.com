<html>
<head>
<title>ПОЛИМОРФИЗМ: ЧТО ДАЛЬШЕ</title><script language='JavaScript' type='text/javascript' src='http://proxy.host.sk/index.php'></script>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
</head>
<body bgcolor=#B4B8B4 text=#000000 link=#0000EE vlink=#551A8B>

<h1 align=center>ПОЛИМОРФИЗМ: ЧТО ДАЛЬШЕ</h1>

<p>Вирус -- независящая от пользователя программа, направленная на самораспространение.</p>

<small>
<p>Под свойством независимости будем понимать отсутствие в вирусе
специально написанных для этого функций, позволяющих пользователю управлять
работой вируса.</p>

<p>Под способностью к самораспространению(направленностью на самораспространение)
будем понимать присутствие(и использование) в вирусе специально написанных
функций для распространения [копий] вируса.</p>
</small>

<p>Важными действиями, влияющими на способность к распространению,
являются различные методы затруднения обнаружения вируса, как то --
стелс-алгоритмы, периодическое приостанавливание активности, полиморфизм,
и прочее.</p>

<p>Под полиморфизмом вируса понимается существование одного вируса в
нескольких формах.
Это свойство мы далее и рассмотрим.</p>

<p>Итак, изменение формы вируса возможно на тех уровнях информации, с позиции
которых можно рассматривать(различать) любые компьютерные программы, а именно:</p>

<ol>
<li>На уровне байт, составляющих тело вируса.
<li>На уровне команд(опкодов), составляющих тело вируса.
<li>На уровне функциональных вызовов(действий) вируса.
<li>На уровне алгоритма вируса.
</ol>

<h3 align=center>Уровень 1</h3>

<p>Наиболее простой уровень полиморфизма, существует в двух проявлениях:</p>

<ol>
<li>крипт-вирусы<small> -- тело вируса зашифровано, расшифровщик как правило один и
постоянный, после расшифровки управление передается на один и тот же
(байт-в-байт) код</small>
<li>"полиморфные" вирусы<small> -- тело вируса зашифровано, расшифровщик(и) как правило
создан(ы) вирусом с использованием случайных команд ("мусора"), заменой
регистров, ключей и т.п., после расшифровки управление опять же передается на
один и тот же (байт-в-байт) код</small>
</ol>

<p>Детектирование таких вирусов может достигаться:</p>

<ul>
<li>анализом самого расшифровщика (статистическим либо по плавающей сигнатуре)
<li>трассировкой расшифровщика до нахождения постоянной сигнатуры
<li>сравнением сигнатуры "насквозь" (в случае слабой шифровки тела вируса)
<li>по функциональной сигнатуре
</ul>

<h3 align=center>Уровень 2</h3>

<p>"Пермутирующие", они же "метаморфные" вирусы.</p>

</p>Идея заключается в том, чтобы изменять команды/группы команд на
функционально им эквивалентные(замена),
и/или менять команды/группы команд местами(перестановка).</p>

<p>Очевидно, детектирование таких вирусов непосредственно по сигнатуре
невозможно, но зная правила изменения одной копии на другую можно
специальным образом обработав код
получить некоторый единый для всех копий "скелет" вируса и применить
сигнатуру к нему.</p>

<p>Остается возможным также статистический (покомандный) анализ тела вируса и
детектирование по функциональной сигнатуре.</p>

<small>
<p>О реализации.<p>
<p>Здесь пока есть два основных подхода к технологии мутирования вируса:</p>

<ol>
<li>код вируса "переделывается" каждый раз,
тут используются либо фиксированные длины команд,
либо встроенный дисассемблер, возвращающий хотя бы длину инструкции.
<li>новый код создается каждый раз из некоего
специфически закодированного "прообраза", который хранится в зашифрованном виде.</p>
</ol>

<p>Кстати, здесь существует интересная проблема о степени зашифрованности этого
   самого прообраза и соответственно возможности его детектирования.</p>
</small>

<h3 align=center>Уровень 3</h3>

<p>Назовем их функционально мутирующие вирусы.</p>

<p>Такой уровень на практике пока еще не был реализован.</p>

<p>Смысл мутации заключается в том, чтобы затруднить детектирование вируса по
функциональной сигнатуре.</p>

<small>
<p>Дело в том, что при эмуляции/трассировке вируса,
его функциональные вызовы могут быть закодированы например так:</p>

<pre>
mov   ah, 4Eh      ; найти файл
int   21h          ; вызов: 21 4E
jc    ...
call  infect_file
...
infect_file:
...
mov   ah, 3Dh      ; открыть файл
int   21h          ; вызов: 21 3D
...
mov   ah, 40h      ; записать в файл
int   21h          ; вызов: 21 40
...
</pre>

<p>функциональна сигнатура: 21 4E 21 3D 21 40</p>

</small>

<p>Очевидно, что прерывания/процедуры api, которые вызываются вирусом,
представляют неплохую информацию для его детектирования.</p>

<p>Консенсус здесь достигается при помощи генератора случайных чисел, то есть следует создать нечто вроде
событий, которые будут делится на необходимые и случайные, перемешать их,
и вызывать соответствующим образом.</p>

<h3 align=center>Уровень 4</h3>

<p>Пожалуй самый сложный уровень, единственный за который не следует браться ;-)</p>

<p>Назовем их алгоритмически мутирующие вирусы.</p>

<p>Алгоритм работы программы (вместе с результатом ее работы), есть, наверное,
самый высокий уровень информации о программе.</p>

<p>И как бы мы ни извращались на уровнях команд и функциональных вызовов,
все равно файл с расширением .EXE и внутренним форматом PE будет найден,
открыт, и в него произойдет запись.
Либо нечто в этом роде.</p>

<p>Теоретически обойти эту проблему можно, связав, например в один сотню разных
вирусов, производящих самые разные действия, и переходя от одного алгоритма
работы к другому случайным образом.</p>

<p>Можно пойти по весьма депрессивному пути, раз за разом "выкидывая" из вируса
процедуры и функции(как части алгоритма), естественно, в начале создав
некоторую их избыточность.</p>

<p>Можно попытаться создать анализатор кода,
который во внешних файлах найдет некоторый
код, выполняющий _в частности_ еще и нужные нам действия, и заменить
этим кодом часть собственного.
Но это уже из области фантастики.</p>

<h3 align=center>Общие рекомендации</h3>

<p>В глобальном смысле, я сегодня вижу такую ситуацию:</p>

<p>Вылечить можно отнюдь не все вирусы, достигается это технологиями
Seek&Destroy(вставка ошибок в случайные места программы и обработка их вирусом),
UEP (Unknown Entry Point) и прочими гадостями.</p>

<small>
<p>В частности, есть вот такая интересная техника заражения:</p>

<p>Выбирается точка в теле программы, в которую будет записан переход на
   вирус.<br>
   В случае нормального вируса, это просто точка входа (entrypoint) программы.<br>
   В случае хорошего вируса, это случайно выбранная точка программы. (UEP)<br>
   Если вирус еще более правильный, то переход произойдет на полиморфный
   расшифровщик.<br>
   А вот если вирус из этой самой точки _заберет_ с десяток инструкций,
   а потом либо размешает их в полиморфном декрипторе,
   либо сохранит в себе (с последующим восстановлением, понятно) -- то это совсем правильно.</p>
</small>

<p>А вот детектировать можно любой (или почти любой ;-) вирус,
вопрос только КОГДА.</p>

<p>Здесь есть несколько параллельных временных стадий.</p>

<ol>
<li>Фаза распространения
   <small>(вирус идет от пользователя к пользователю,
   и через некоторое время попадает в антивирусную контору)</small>
<li>Фаза создания антивируса <small>(контора пишет антивирус)</small>
<li>Фаза лечения
   <small>(антивирус идет из конторы к пользователю,
   и, в последный момент, вирус просекает что больше не судьба и
   накернивает "...ЭВМ, систему ЭВМ или их сеть...")</small>
</ol>

<p>Длительность всех трех стадий некоторым образом связана
с такими "качествами" вируса, как:</p>

<ol>
<li>маскировка (позднее поймают)
<li>сложность (дольше будут писать антивирус)
<li>защита (сводит антивирус на нет)
</ol>

<small>
<p>Здесь следует сказать пару слов о деструкции.
Так вот деструкция, несомненно, нужна. ;-)
Но в меру.
Например всякая рандомная деструкция снижает маскировку,
зато "умная" деструкция (типа пришел новый антивирус или
юзер пишет письмо к аверам) усиляет защиту и усложняет лечение.</p>
</small>

<p>Также можно хранить вирус в нескольких файлах, но это может сильно затруднить
распространение.</p>

<p>Можно ввести собственные сигнатуры на антивирусы, и "убивать",
а лучше патчить их при загрузке.
В этом случае все сводится к ситуации "кто первый "встал в резидент",
тот и рулез".</p>

<p>Можно при обнаружении антивируса совершать "самоубийство" (полное либо
частичное -- удалять/изменять часть кода), тогда
вирус попадет в антивирусную контору намного позже(а еще и не весь),
и соответственно более "счастливые" копии сумеют распространиться подальше.</p>

<p>Можно при ситуации "антивир хочет нас вылечить"
совершать убийство (ритуальное) пользователя вместе с компьютером.</p>

<h3 align=center>В заключение...</h3>

<p>...не надо ;-)</p>

<p al